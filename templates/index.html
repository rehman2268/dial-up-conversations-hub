
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twilio Dialer</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="bg-white shadow rounded-lg mb-6 p-4">
            <h1 class="text-2xl font-bold text-gray-800">Twilio Dialer</h1>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Dialer Section -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">Make a Call</h2>
                <div class="mb-4">
                    <label for="phone-number" class="block text-gray-700 mb-2">Phone Number</label>
                    <input type="tel" id="phone-number" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="(555) 123-4567">
                </div>
                <button id="call-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    Call
                </button>
            </div>

            <!-- Active Call Section (initially hidden) -->
            <div id="active-call" class="bg-white shadow rounded-lg p-6 hidden">
                <h2 class="text-xl font-semibold mb-4">Active Call</h2>
                <div class="mb-4">
                    <p>Connected to: <span id="active-call-number" class="font-semibold"></span></p>
                    <p>Status: <span id="call-status" class="font-semibold">In progress</span></p>
                    <p>Duration: <span id="call-duration" class="font-semibold">00:00</span></p>
                </div>
                <div class="flex space-x-2">
                    <button id="mute-button" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        Mute
                    </button>
                    <button id="hold-button" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        Hold
                    </button>
                    <button id="end-call-button" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        End
                    </button>
                </div>
            </div>

            <!-- Call History Section -->
            <div class="bg-white shadow rounded-lg p-6 md:col-span-2">
                <h2 class="text-xl font-semibold mb-4">Call History</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full table-auto">
                        <thead>
                            <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Phone Number</th>
                                <th class="py-3 px-6 text-left">Direction</th>
                                <th class="py-3 px-6 text-left">Status</th>
                                <th class="py-3 px-6 text-left">Duration</th>
                                <th class="py-3 px-6 text-left">Timestamp</th>
                            </tr>
                        </thead>
                        <tbody id="call-history" class="text-gray-600 text-sm">
                            <!-- Call history will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Utility functions
        function formatPhoneNumber(input) {
            const cleaned = input.replace(/\D/g, '');
            let formatted = cleaned;
            
            if (cleaned.length > 0) {
                if (cleaned.length <= 3) {
                    formatted = `(${cleaned}`;
                } else if (cleaned.length <= 6) {
                    formatted = `(${cleaned.slice(0, 3)}) ${cleaned.slice(3)}`;
                } else {
                    formatted = `(${cleaned.slice(0, 3)}) ${cleaned.slice(3, 6)}-${cleaned.slice(6, 10)}`;
                }
            }
            
            return formatted;
        }

        // Format timestamps to a more readable format
        function formatTimestamp(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString();
        }

        // Format duration in seconds to MM:SS
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Call API functions
        async function makeCall(phoneNumber) {
            try {
                const response = await fetch('/api/call', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ phone_number: phoneNumber }),
                });
                
                if (!response.ok) {
                    throw new Error('Failed to make call');
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error making call:', error);
                alert('Failed to make call. Please check console for details.');
                return null;
            }
        }

        async function getCallHistory() {
            try {
                const response = await fetch('/api/calls');
                
                if (!response.ok) {
                    throw new Error('Failed to fetch call history');
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching call history:', error);
                return [];
            }
        }

        async function endCall(callId) {
            try {
                const response = await fetch(`/api/call/${callId}/end`, {
                    method: 'POST',
                });
                
                if (!response.ok) {
                    throw new Error('Failed to end call');
                }
                
                return true;
            } catch (error) {
                console.error('Error ending call:', error);
                return false;
            }
        }

        async function toggleMute(callId, mute) {
            try {
                const response = await fetch(`/api/call/${callId}/mute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ mute }),
                });
                
                if (!response.ok) {
                    throw new Error('Failed to toggle mute');
                }
                
                return true;
            } catch (error) {
                console.error('Error toggling mute:', error);
                return false;
            }
        }

        async function toggleHold(callId, hold) {
            try {
                const response = await fetch(`/api/call/${callId}/hold`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ hold }),
                });
                
                if (!response.ok) {
                    throw new Error('Failed to toggle hold');
                }
                
                return true;
            } catch (error) {
                console.error('Error toggling hold:', error);
                return false;
            }
        }

        // DOM elements
        const phoneNumberInput = document.getElementById('phone-number');
        const callButton = document.getElementById('call-button');
        const activeCallSection = document.getElementById('active-call');
        const activeCallNumber = document.getElementById('active-call-number');
        const callStatus = document.getElementById('call-status');
        const callDuration = document.getElementById('call-duration');
        const muteButton = document.getElementById('mute-button');
        const holdButton = document.getElementById('hold-button');
        const endCallButton = document.getElementById('end-call-button');
        const callHistoryTable = document.getElementById('call-history');

        // State variables
        let activeCall = null;
        let durationInterval = null;
        let durationSeconds = 0;
        let isMuted = false;
        let isOnHold = false;

        // Event listeners
        phoneNumberInput.addEventListener('input', (event) => {
            event.target.value = formatPhoneNumber(event.target.value);
        });

        callButton.addEventListener('click', async () => {
            const phoneNumber = phoneNumberInput.value;
            if (!phoneNumber) {
                alert('Please enter a phone number');
                return;
            }
            
            callButton.disabled = true;
            callButton.textContent = 'Calling...';
            
            const call = await makeCall(phoneNumber);
            
            if (call) {
                // Show active call section
                activeCallNumber.textContent = phoneNumber;
                callStatus.textContent = 'Connecting...';
                activeCallSection.classList.remove('hidden');
                
                // Set active call
                activeCall = call;
                
                // Start duration timer if call is connected
                startDurationTimer();
                
                // Load updated call history
                loadCallHistory();
            }
            
            callButton.disabled = false;
            callButton.textContent = 'Call';
        });

        muteButton.addEventListener('click', async () => {
            if (!activeCall) return;
            
            isMuted = !isMuted;
            const success = await toggleMute(activeCall.id, isMuted);
            
            if (success) {
                muteButton.textContent = isMuted ? 'Unmute' : 'Mute';
                muteButton.classList.toggle('bg-gray-500', !isMuted);
                muteButton.classList.toggle('bg-blue-500', isMuted);
            }
        });

        holdButton.addEventListener('click', async () => {
            if (!activeCall) return;
            
            isOnHold = !isOnHold;
            const success = await toggleHold(activeCall.id, isOnHold);
            
            if (success) {
                holdButton.textContent = isOnHold ? 'Resume' : 'Hold';
                holdButton.classList.toggle('bg-yellow-500', !isOnHold);
                holdButton.classList.toggle('bg-green-500', isOnHold);
                callStatus.textContent = isOnHold ? 'On Hold' : 'In Progress';
            }
        });

        endCallButton.addEventListener('click', async () => {
            if (!activeCall) return;
            
            const success = await endCall(activeCall.id);
            
            if (success) {
                stopDurationTimer();
                activeCallSection.classList.add('hidden');
                activeCall = null;
                isMuted = false;
                isOnHold = false;
                durationSeconds = 0;
                resetCallControls();
                loadCallHistory();
            }
        });

        // Functions for managing the active call
        function startDurationTimer() {
            stopDurationTimer(); // Clear any existing interval
            durationSeconds = 0;
            callDuration.textContent = formatDuration(durationSeconds);
            
            durationInterval = setInterval(() => {
                durationSeconds++;
                callDuration.textContent = formatDuration(durationSeconds);
            }, 1000);
        }

        function stopDurationTimer() {
            if (durationInterval) {
                clearInterval(durationInterval);
                durationInterval = null;
            }
        }

        function resetCallControls() {
            muteButton.textContent = 'Mute';
            muteButton.classList.remove('bg-blue-500');
            muteButton.classList.add('bg-gray-500');
            
            holdButton.textContent = 'Hold';
            holdButton.classList.remove('bg-green-500');
            holdButton.classList.add('bg-yellow-500');
            
            callStatus.textContent = 'In Progress';
        }

        // Load and display call history
        async function loadCallHistory() {
            const history = await getCallHistory();
            
            // Clear existing history
            callHistoryTable.innerHTML = '';
            
            // Add history items
            history.forEach(call => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-100';
                
                row.innerHTML = `
                    <td class="py-3 px-6 text-left">${call.phone_number}</td>
                    <td class="py-3 px-6 text-left capitalize">${call.direction}</td>
                    <td class="py-3 px-6 text-left capitalize">${call.status}</td>
                    <td class="py-3 px-6 text-left">${formatDuration(call.duration)}</td>
                    <td class="py-3 px-6 text-left">${formatTimestamp(call.timestamp)}</td>
                `;
                
                callHistoryTable.appendChild(row);
            });
        }

        // Initial call history load
        loadCallHistory();

        // For testing: simulate an inbound call
        async function simulateInboundCall(phoneNumber) {
            try {
                const response = await fetch('/api/simulate/inbound-call', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ phone_number: phoneNumber }),
                });
                
                if (!response.ok) {
                    throw new Error('Failed to simulate inbound call');
                }
                
                const data = await response.json();
                loadCallHistory();
                return data;
            } catch (error) {
                console.error('Error simulating inbound call:', error);
                return null;
            }
        }

        // Uncomment this to test the inbound call simulation
        // setTimeout(() => {
        //     simulateInboundCall("(555) 987-6543");
        // }, 5000);
    </script>
</body>
</html>
